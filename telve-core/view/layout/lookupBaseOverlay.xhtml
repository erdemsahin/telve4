<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://java.sun.com/jsp/jstl/core">

    <p:fragment id="frmovl">
        <div class="row" style="width: 450px;">
            <h:panelGroup layout="block" styleClass="large-12 small-12 medium-12 columns">
                <ui:fragment rendered="#{not hideStandartFilter}">
                    <p:fragment>
                        <p:outputLabel for="search2key" value="#{messages['general.label.SearchKey']}" />
                        <h:panelGroup styleClass="ui-input-group" layout="block" >
                            <p:inputText id="search2key" value="#{lookupBean.model.searchText}" />
                            <p:commandButton id="search2" icon="ui-icon-search" action="#{lookupBean.search()}" update="resultLists" styleClass="ui-icon-only" 
                                             partialSubmit="true" process="search2key"/>
                        </h:panelGroup>
                    </p:fragment>
                </ui:fragment>
            </h:panelGroup>



            <h:panelGroup id="resultLists" layout="block" styleClass="large-12 small-12 medium-12 columns">

                <c:if test="#{ lookupBean.model.modelType eq 'Table' and lookupBean.model.getMultiSelect()}" >
                    <p:dataTable id="multiSelectDialog" var="item" value="#{lookupBean.model.dataModel()}" 
                                 selection="#{lookupBean.model.selectedDatas}" rows="5"  paginator="true" rowKey="#{item.id}"
                                 paginatorPosition="bottom" 
                                 paginatorAlwaysVisible="false">

                        <p:column selectionMode="multiple" style="width:36px;" />  

                        <c:forEach items="#{lookupBean.model.columns.entrySet()}" var="col" varStatus="loop">
                            <p:column headerText="#{messages[col.value]}">
                                #{item[col.key]}
                            </p:column>
                        </c:forEach>
                    </p:dataTable>
                    <script type="text/javascript">
                            function setSelections(){}
                        </script>
                </c:if>

                <c:if test="#{ lookupBean.model.modelType eq 'Table' and not lookupBean.model.getMultiSelect()}" >

                    <p:dataTable id="singleSelectDialog" var="item" value="#{lookupBean.model.dataModel()}" 
                                 selection="#{lookupBean.model.selectedData}" rows="5"  paginator="true" rowKey="#{item.id}"
                                 paginatorPosition="bottom" 
                                 paginatorAlwaysVisible="false">

                        <p:column selectionMode="single" style="width:36px;" />  

                        <c:forEach items="#{lookupBean.model.columns.entrySet()}" var="col" varStatus="loop">
                            <p:column headerText="#{messages[col.value]}">
                                #{item[col.key]}
                            </p:column>
                        </c:forEach>
                    </p:dataTable>
                    <script type="text/javascript">
                            function setSelections(){}
                        </script>
                </c:if>

                <c:if test="#{lookupBean.model.modelType eq 'Tree' }" >

                        <h:inputHidden id="selectedNodes" value="#{lookupBean.model.selectedNodes}" />
                        <div id="data" ></div>
                        
                        <script type="text/javascript">
                            
                            function buildTree(){
                                    // inline data 
                                    jQuery("#data")
                                        .on("changed.jstree", function (e, data) {
                                            //alert( data.instance.get_node(data.selected[0]).id );
                                            //selectNode( [ { 'name': 'nodeId', 'value' : data.instance.get_node(data.selected[0]).id }]);
                                        })    
                                        .jstree({
                                            "plugins" : [ "wholerow", "types", "#{ lookupBean.model.getMultiSelect() ? 'checkbox' : '' }" ],
                                            "types" : {
                                                "default" : {
                                                    "icon" : "fa fa-folder"
                                                },
                                                #{nodeTypes}
                                            },
                                            'core' : {
                                                'data' : [
                                                    <ui:repeat value = "#{lookupBean.model.dataModel()}" var = "node" >
                                                        { "id" : "#{node.id}", "parent" : "#{node.parentId eq 0 ? '#' : node.parentId}", "text" : "#{node.caption}", "type" : "#{lookupBean.model.getNodeType(node)}" },
                                                    </ui:repeat>

                                                ]
                                            }
                                        });
                                    }
                                    buildTree();
                                    
                                    function setNodeSelections(){
                                            $('#data').jstree().select_node(jQuery(PrimeFaces.escapeClientId("lookupForm:selectedNodes")).val().split(','));
                                    }

                                    function setSelections(){
                                            var s = jQuery('#data').jstree().get_selected();
                                            jQuery(PrimeFaces.escapeClientId("#{ccId}:selectedNodes")).val(s);
                                    }

                                    //setNodeSelections();                                
                                </script>
                </c:if>
            </h:panelGroup>
            <h:panelGroup layout="block" styleClass="large-12 small-12 medium-12 columns">
                <div class="actionButtons">
                    <p:commandButton value="#{messages['general.button.Ok']}"  
                                     action="#{lookupBean.closeOverlay()}" ajax="true" 
                                     onsuccess="PF('#{widgetVar}').hide();" update="#{update}"
                                     partialSubmit="true" process="frmovl" styleClass="btn-primary" onclick="setSelections(this)"
                                     icon="fa fa-check"/>
                    <p:commandButton value="#{messages['general.button.Cancel']}" type="button" onclick="PF('#{widgetVar}').hide();" 
                                     icon="ui-icon-close"/>
                </div>
            </h:panelGroup>

        </div>
    </p:fragment>
</ui:composition>
