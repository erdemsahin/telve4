<!DOCTYPE html >
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:t="http://java.sun.com/jsf/composite/telveComponents"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      xmlns:ds="http://deltaspike.apache.org/jsf"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <f:view >
        <ui:insert name="metadata" />

        <h:head>    


            <title>#{telveConfigResolver.getProperty('app.title')} - #{ pageTitleResolver.pageTitle }</title>

            <ui:include src="/layout/templateHeader.xhtml" />
            
        </h:head>

        <h:body >

            <ds:windowId />

            <h:form>
                <p:remoteCommand name="updateNotifies" update="notifyCount"  />
            </h:form>

            <p:confirmDialog global="true" showEffect="fade" hideEffect="explode">
                <p:commandButton value="#{messages['general.button.Yes']}" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                <p:commandButton value="#{messages['general.button.No']}" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
            </p:confirmDialog>

            <p:notificationBar id="notifyBar" position="top" effect="slide" styleClass="top alert-info" style="z-index: 3000; margin: 0;" widgetVar="notifyBar" >
                <i id="notifyIcon" class=""/>
                <span id="notifySubject" style="font-size:36px;"></span>
                <br/>
                <span id="notifyDetail" style="font-size:22px;"></span>
            </p:notificationBar>

            <p:socket onMessage="handleMessage" channel="/notify/#{identity.account.id}" />

            <script type="text/javascript">

                jQuery("#notifyBar").bind("click", function () {
                    PF('notifyBar').hide();
                });

                function hideBar() {
                    PF('notifyBar').hide();
                }

                function handleMessage(notify) {
                    //facesmessage.severity = 'info';
                    //alert(facesmessage.summary);
                    jQuery("#notifyBar").addClass("alert-" + notify.severity);
                    jQuery("#notifyIcon").addClass("fa fa-3x " + notify.icon);
                    jQuery("#notifySubject").html(notify.subject);
                    jQuery("#notifyDetail").html(notify.body);

                    PF('notifyBar').show();
                    setTimeout(function () {
                        PF('notifyBar').hide();
                    }, 2000);

                    updateNotifies();
                }
            </script>

            <ui:insert name="outerspace"></ui:insert>

            <div class="wrapper">

                <header class="fixed main-header">
                    <p:ajaxStatus onstart="NProgress.start();" onsuccess="NProgress.done();" />

                    <h:link outcome="/home.xhtml" styleClass="logo">#{telveConfigResolver.getProperty('app.title')}</h:link>
                    <nav class="navbar navbar-static-top" role="navigation">
                        <!-- Sidebar toggle button-->

                        <ui:remove>
                            <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                                <span class="sr-only">Toggle navigation</span>
                            </a>
                        </ui:remove>

                        <script type="text/javascript">
                            jQuery(document).ready(function () {
                                jQuery('#sideToggle').click(function (e) {
                                    e.preventDefault();

                                    //Enable sidebar push menu
                                    if (jQuery(window).width() > (767 - 1)) {
                                        jQuery("body").toggleClass('sidebar-collapse');
                                    }
                                    //Handle sidebar push menu for small screens
                                    else {
                                        if (jQuery("body").hasClass('sidebar-open')) {
                                            jQuery("body").removeClass('sidebar-open');
                                            jQuery("body").removeClass('sidebar-collapse')
                                        } else {
                                            jQuery("body").addClass('sidebar-open');
                                        }
                                    }
                                });

                                jQuery('#listToggle').click(function (e) {
                                    e.preventDefault();

                                    //Enable sidebar push menu
                                    if (jQuery(window).width() > (767 - 1)) {
                                        jQuery("body").toggleClass('listbar-collapse');
                                    }
                                    //Handle sidebar push menu for small screens
                                    else {
                                        if (jQuery("body").hasClass('sidebar-open')) {
                                            jQuery("body").removeClass('sidebar-open');
                                            jQuery("body").removeClass('sidebar-collapse')
                                        } else {
                                            jQuery("body").addClass('sidebar-open');
                                        }
                                    }
                                });
                            });
                        </script>


                        <div class="navbar-menu">


                            <ul class="nav navbar-nav">
                                <li>
                                    <a id="sideToggle" href="#" role="button" >
                                        <i class="fa fa-bars"></i>
                                    </a>
                                </li>
                                <li>
                                    <a id="listToggle" href="#" role="button" >
                                        <i class="fa fa-expand"></i>
                                    </a>
                                </li>
                                <!-- Main Navigations -->
                                <ui:repeat value="#{nagivationController.mainNavigations}" var="nav" >
                                    <li >
                                        <h:link  outcome="#{nav.viewId}" >
                                            <i class="#{nav.icon}"></i>
                                        </h:link>
                                    </li>
                                </ui:repeat>
                                
                            </ul>
                        </div>

                        <div class="navbar-custom-menu">
                            <ul class="nav navbar-nav">

                                <li>

                                    <p:commandLink id="notesLink"  ajax="true" partialSubmit="true" process="@this" update=":notesContent" rendered="#{noteController.canAddNote()}">
                                        <i class="fa fa-comments"/>
                                        <ui:fragment rendered="#{noteController.hasNotes('')}">
                                            <span class="label label-success">#{noteController.noteCount('')}</span>
                                        </ui:fragment>
                                    </p:commandLink>

                                </li>

                                <p:overlayPanel id="notes"  widgetVar="notes" dynamic="true" style="min-width: 250px; min-height: 100px;" for="notesLink">
                                    <p:commandLink action="#{noteController.openNewNoteDialog(request.getHeader('Referer'))}" 
                                                   ajax="true" partialSubmit="true" process="@this" includeViewParams="true" 
                                                   oncomplete="PF('notes').hide();">
                                        <i class="fa fa-comment"/>
                                        #{messages['general.button.New']}
                                    </p:commandLink>


                                    <h:panelGroup id="notesContent">
                                        <h:outputText value="Mevcut not bulunmuyor." rendered="#{not noteController.hasNotes('')}" style="display: block;"/>
                                        <ui:repeat value="#{noteController.notes}" var="note" >
                                            <div class="ui-messages-#{note.priority} ui-corner-all">

                                                <p:commandLink action="#{noteController.delete(note)}" update=":notesContent" class="pull-right" rendered="#{noteController.canDelete(note)}">
                                                    <i class="fa fa-close"/>
                                                </p:commandLink>

                                                <div class="row">
                                                    <div class="large-12 medium-12 small-12 columns">
                                                        <h:outputText value="#{note.subject}" styleClass="ui-messages-#{note.priority}-summary" style="margin-left: 0"/>
                                                    </div>
                                                    <div class="large-12 medium-12 small-12 columns">
                                                        <h:outputText value="#{note.body}" styleClass="ui-messages-#{note.priority}-detail" style="margin-left: 0"/>
                                                    </div>
                                                </div>
                                                <div class="row" style="margin-top: 16px;">
                                                    <i class="fa fa-clock-o"/> 
                                                    <h:outputText value="#{note.createDate}" style="margin-left: 2px;">
                                                        <f:convertDateTime pattern="#{messages['general.format.DateTime']}" />
                                                    </h:outputText>
                                                    <i class="fa fa-user"/> 
                                                    <h:outputText value="#{userLookup.getUserNameById( note.owner)}" style="margin-left: 2px;" />

                                                    <i class="fa #{note.permission eq 'OWNER' ? 'fa-lock' : 'fa-unlock-alt' } pull-right"/>
                                                </div>
                                            </div>
                                        </ui:repeat>
                                    </h:panelGroup>
                                </p:overlayPanel>

                                <li>
                                    <ui:remove>
                                        <!-- 
                                        request.requestURI.concat( '?' ).concat(request.queryString) çalışması lazım ama ajax üzerinde redirect yaparken parametreleri kaybediyor
                                        o yüzden referer'ı kullanıyoruz.
                                        -->
                                    </ui:remove>
                                    <p:commandLink action="#{bookmarkDashlet.addBookmark( messages[pageTitleResolver.pageTitle], viewIdentifier, request.getHeader('Referer'))}" 
                                                   ajax="true" partialSubmit="true" process="@this" includeViewParams="true" >
                                        <i class="fa fa-bookmark" />
                                    </p:commandLink>
                                </li>

                                <li >
                                    <p:commandLink id="notifies"  ajax="true" partialSubmit="true" process="@this" update=":notifyPanelContent">
                                        <i class="fa fa-bell-o"></i>
                                        <h:panelGroup id="notifyCount" styleClass="#{notifyStore.getNotifyCount(identity.account.id) gt 0 ? 'label label-warning' : ''}">
                                            <h:outputText value="#{notifyStore.getNotifyCount(identity.account.id)}" styleClass="" rendered="#{notifyStore.getNotifyCount(identity.account.id) gt 0}"/>
                                        </h:panelGroup>
                                    </p:commandLink>
                                </li>


                                <p:overlayPanel id="notifyPanel" widgetVar="notifyPanel" dynamic="true" style="width: 250px; height: 300px;" for="notifies">
                                    <h:panelGroup id="notifyPanelContent" layout="block" style="margin-left: -15; margin-right: -15;">
                                        <div style="margin-left: 15px; margin-right: 15px;">
                                            <p:commandLink action="#{notifyStore.clear(identity.account.id)}" ajax="true" 
                                                           partialSubmit="true" process="@this" update=":notifyCount" 
                                                           styleClass="pull-right"
                                                           oncomplete="PF('notifyPanel').hide();">
                                                <i class="fa fa-trash"></i>
                                                #{messages['general.button.Delete']}
                                            </p:commandLink>
                                            <span style="font-size:1.2em; color:#004369">#{notifyStore.getNotifyCount(identity.account.id)} uyarınız var!</span>
                                        </div>
                                        
                                        <ul id="notifyList" class="menulist">
                                            <ui:repeat value="#{notifyStore.getNotifies(identity.account.id)}" var="notify">
                                                <li class="">
                                                    <a href="#" >
                                                        <div class="menuIcon">
                                                            <i class="fa fa-2x #{notify.icon}" /> 
                                                        </div>
                                                        <div class="menuText">
                                                            <div class="">#{notify.subject}</div>
                                                            <span class="menuMuteText">#{notify.body}</span>
                                                        </div>
                                                    </a>
                                                </li>
                                            </ui:repeat>
                                        </ul>
                                        
                                        <script type="text/javascript">
                                        jQuery("#notifyList").slimscroll({
                                            height: "250px",
                                            width: "250px",
                                            color: "rgba(0,0,0,0.2)",
                                            size: "1px"
                                          });
                                        </script>
                                    </h:panelGroup>
                                    
                                    
                                </p:overlayPanel>

                                <li class="">
                                    <a href="#{helpResolver.helpPath}" target="HelpWinId" onclick="openHelp();" >
                                        <i class="fa fa-question-circle"></i>

                                    </a>
                                </li>

                                <li class="dropdown user user-menu">
                                    <a id="hedelink" href="#" class="dropdown-toggle" data-toggle="dropdown" onclick="PF('hede').show('hedelink')">
                                        <!-- img src="dist/img/user2-160x160.jpg" class="user-image" alt="User Image" -->
                                        <span class="hidden-xs">#{identity.account.firstName} #{identity.account.lastName}</span>
                                    </a>
                                    <p:overlayPanel id="hede" widgetVar="hede" >
                                        <ul class="dropdown-menu">
                                            <li>
                                                <h:link outcome="/options.xhtml">
                                                    <i class="fa fa-gears" /> #{messages['module.caption.Options']}
                                                </h:link>
                                            </li>
                                            <li>
                                                <p:commandLink action="#{aboutController.openDialog()}" 
                                                               ajax="true" partialSubmit="true" process="@this" includeViewParams="true" >
                                                    <i class="fa fa-question-circle" /> #{messages['general.button.About']}
                                                </p:commandLink>

                                            </li>
                                            <li class="seperator"></li>
                                            <li>
                                                <h:form>
                                                    <p:commandLink action="#{loginController.logout()}" ajax="false">
                                                        <i class="fa fa-power-off" /> #{messages['general.button.Logout']}
                                                    </p:commandLink>
                                                </h:form>
                                            </li>
                                        </ul>
                                    </p:overlayPanel>
                                </li>

                            </ul>
                        </div>
                    </nav>
                </header>


                <aside class="main-sidebar">

                    <section class="sidebar" style="height: auto;">

                        <ui:remove>
                            <h:form id="globalSearch">
                                <div class="ui-input-group" style="padding: 10px;">
                                    <p:inputText value="#{quickLauncher.key}" required="false"  placeholder="#{messages['general.label.SearchText']}"/>
                                    <p:commandButton action="#{quickLauncher.redirect()}" icon="fa fa-search" partialSubmit="false" />
                                </div>
                            </h:form>
                        </ui:remove>


                        <ul class="sidebar-menu">

                            <ui:remove>
                                <li class="header">#{messages["Main Menu"]}</li>
                            </ui:remove>
                            <!-- Side Main Navigations -->
                            <ui:repeat value="#{nagivationController.sideNavigations}" var="nav" >
                                
                                <li>
                                    <h:link  outcome="#{nav.viewId}" >
                                        <ui:remove>
                                        <c:forEach items="#{action.action.params}" var="entry">
                                            <f:param name="#{entry.key}" value="#{entry.value}"/>
                                        </c:forEach>
                                        </ui:remove>

                                        <h:graphicImage value="/img/ribbon/small#{nav.icon}"  style="margin-right: 4px;" rendered="#{nav.fontIcon}"/>
                                        <ui:fragment rendered="#{not nav.fontIcon}">
                                            <i class="#{nav.icon}"></i>
                                        </ui:fragment>
                                        <span style="padding-right: 4px;">#{messages[nav.label]}</span> 

                                    </h:link>
                                </li>
                                
                            </ui:repeat>
                            
                            <li class="header">#{messages["general.label.Navigation"]}</li>
                            <ui:repeat value="#{nagivationController.navigationSections}" var="section" >
                                <li class="treeview">
                                    <a href="#">
                                        <i class="fa fa-caret-right"></i>
                                        <span>#{messages[section.label]}</span>

                                        <ui:remove>
                                            <span class="label label-primary pull-right">4</span>
                                        </ui:remove>
                                    </a>
                                    <ul class="treeview-menu">
                                        <ui:repeat value="#{nagivationController.getSectionLinks(section.label)}" var="nav" >
                                            <li>
                                                <h:link  outcome="#{ nav.viewId }" >
                                                    <ui:remove>
                                                        <c:forEach items="#{action.action.params}" var="entry">
                                                            <f:param name="#{entry.key}" value="#{entry.value}"/>
                                                        </c:forEach>
                                                    </ui:remove>
                                                    
                                                    <h:graphicImage value="/img/ribbon/small#{nav.icon}"  style="margin-right: 4px;" rendered="#{nav.fontIcon}"/>
                                                    <ui:fragment rendered="#{not nav.fontIcon}">
                                                        <i class="#{nav.icon}"></i>
                                                    </ui:fragment>
                                                    <span style="padding-right: 4px;">#{messages[nav.label]}</span> 
                                                    </h:link>
                                                </li>
                                        </ui:repeat>
                                    </ul>
                                </li>
                            </ui:repeat>
                        </ul>
                        <ui:remove>
                            <div>
                                <p>Günün İp Uçusu gibi bişiler buraya doğru gelebilir belki...</p>
                            </div>
                        </ui:remove>
                    </section>
                </aside>


                <ui:fragment rendered="#{showListBar}">
                    <div class="main-listbar" >
                        <div class="content-list" >
                            <ui:remove>
                                <section class="main-header" >
                                    <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                                        <span class="sr-only">Toggle navigation</span>
                                    </a>

                                    <nav class="navbar navbar-static-top" role="navigation">

                                    </nav>
                                </section>
                            </ui:remove>
                            <div class="list-content">
                                <ui:insert name="content-list" />
                            </div>
                        </div>
                    </div>
                    
                    <script type="text/javascript">
                        
                        hideListBar = '${hideListBar}';
                        if( hideListBar == 'true'){
                            //jQuery('#listToggle').click();
                            jQuery("body").toggleClass('listbar-collapse');
                        }
                        
                    </script>
                    
                </ui:fragment>

                <div class="content-wrapper #{showListBar ? 'listbar' : ''} ">

                    <div class="main-content">
                        <section class="context-menu">
                            <h:form id="contextForm">
                                <ul >
                                    <ui:insert name="context-menu" />
                                </ul>
                            </h:form>
                        </section>
                        <ui:fragment rendered="#{dontShowContentHeader ne true}">
                            <section class="content-header">
                                <h1>#{ messages[pageTitleResolver.pageTitle] }  <small>#{ viewIdentifier }</small></h1> 
                            </section>
                        </ui:fragment>
                        <ui:insert name="customHeader" />

                        <div class="content">
                            <ui:insert name="body"/>
                        </div>
                    </div>
                </div>


                <footer class="main-footer">
                    
                    <div class="pull-right hidden-xs">
                        <b>Version</b> #{telveConfigResolver.getProperty('app.version')}
                    </div>
                    
                    <strong>#{telveConfigResolver.getProperty('app.footer')}</strong> 
                    
                </footer>
            </div>
        </h:body>

    </f:view>
</html>
